/**
 * Agora RTM ç®¡ç†å™¨å•ä¾‹ (é€‚é… agora-rtm-sdk 1.5.1 ç‰ˆæœ¬)
 * ç”¨äºåœ¨é€šè¯ä¸­è¿›è¡Œå®æ—¶æ¶ˆæ¯æ”¶å‘
 *
 * ä½¿ç”¨æµç¨‹ï¼š
 * 1. åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ login() ç™»å½• RTM
 * 2. è¿›å…¥é€šè¯æ—¶è°ƒç”¨ joinChannel() åŠ å…¥é¢‘é“
 * 3. ç¦»å¼€é€šè¯æ—¶è°ƒç”¨ leaveChannel() ç¦»å¼€é¢‘é“
 * 4. åº”ç”¨é€€å‡ºæ—¶è°ƒç”¨ logout() ç™»å‡º RTM
 */
import AgoraRTM from "agora-rtm-sdk";
import store from "@/store";
import { getRtmToken } from "@/api/sdk/call";

// è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹ï¼ˆä¸ TencentImUtils ä¿æŒä¸€è‡´ï¼‰
export const RTM_MSG_TYPE = {
  TEXT: 'MSG_TEXT',           // æ–‡æœ¬æ¶ˆæ¯
  CUSTOM: 'MSG_CUSTOM',       // è‡ªå®šä¹‰æ¶ˆæ¯
  GIFT: 2000,                 // ç¤¼ç‰©æ¶ˆæ¯ç±»å‹
};

class AgoraRTMManager {
  constructor() {
    // å•ä¾‹å®ä¾‹
    if (AgoraRTMManager.instance) {
      return AgoraRTMManager.instance;
    }
    AgoraRTMManager.instance = this;

    // RTM å®¢æˆ·ç«¯
    this.rtmClient = null;
    // RTM é¢‘é“
    this.rtmChannel = null;
    // å½“å‰é¢‘é“åç§°
    this.currentChannel = null;
    // æ˜¯å¦å·²ç™»å½•
    this.isLoggedIn = false;
    // æ˜¯å¦å·²åŠ å…¥é¢‘é“
    this.isJoinedChannel = false;
    // æ¶ˆæ¯å›è°ƒå‡½æ•°
    this.onMessageCallback = null;
    // å½“å‰ç”¨æˆ· ID
    this.currentUserId = null;
    // App ID
    this.appId = null;
    // RTM Token
    this.rtmToken = null;
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance() {
    if (!AgoraRTMManager.instance) {
      AgoraRTMManager.instance = new AgoraRTMManager();
    }
    return AgoraRTMManager.instance;
  }

  /**
   * ç™»å½• RTMï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
   * @param {string} appId - Agora App ID
   * @param {string|number} userId - ç”¨æˆ· ID
   * @returns {Promise<boolean>}
   */
  async login(appId, userId) {
    // å¦‚æœå·²ç»ç™»å½•ï¼Œç›´æ¥è¿”å›
    if (this.isLoggedIn && this.rtmClient) {
      console.log('[ğŸ“¨AgoraRTMManager] å·²ç™»å½•ï¼Œè·³è¿‡');
      return true;
    }

    try {
      console.log('[ğŸ“¨AgoraRTMManager] å¼€å§‹ç™»å½• RTM...', { appId, userId });

      this.appId = appId;
      this.currentUserId = String(userId);

      // 1. è·å– RTM Token
      console.log('[ğŸ“¨AgoraRTMManager] è·å– RTM Token...');
      const tokenResponse = await getRtmToken();
      if (!tokenResponse || !tokenResponse.success) {
        throw new Error('è·å– RTM Token å¤±è´¥');
      }
      this.rtmToken = tokenResponse.data?.rtmToken || tokenResponse.data;
      console.log("appid", appId);
      console.log("userId", this.currentUserId);
      console.log('[ğŸ“¨AgoraRTMManager] âœ… RTM Token è·å–æˆåŠŸ', this.rtmToken);

      // 2. åˆ›å»º RTM å®¢æˆ·ç«¯ (RTM 1.x æ–¹å¼)
      this.rtmClient = AgoraRTM.createInstance(appId);
      console.log('[ğŸ“¨AgoraRTMManager] âœ… RTM Client åˆ›å»ºæˆåŠŸ');

      // 3. è®¾ç½®äº‹ä»¶ç›‘å¬
      this._setupEventListeners();

      // 4. ç™»å½• RTM (RTM 1.x æ–¹å¼)
      console.log('[ğŸ“¨AgoraRTMManager] ç™»å½• RTM...');
      await this.rtmClient.login({
        uid: this.currentUserId,
        token: this.rtmToken
      });
      this.isLoggedIn = true;
      console.log('[ğŸ“¨AgoraRTMManager] âœ… RTM ç™»å½•æˆåŠŸ');

      return true;
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] ç™»å½•å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * åŠ å…¥é¢‘é“ï¼ˆè¿›å…¥é€šè¯æ—¶è°ƒç”¨ï¼‰
   * @param {string} channelName - é¢‘é“åç§°ï¼ˆé€šè¯ç¼–å·ï¼‰
   * @returns {Promise<boolean>}
   */
  async joinChannel(channelName) {
    if (!this.isLoggedIn || !this.rtmClient) {
      throw new Error('RTM æœªç™»å½•ï¼Œè¯·å…ˆè°ƒç”¨ login()');
    }

    // å¦‚æœå·²ç»åœ¨åŒä¸€ä¸ªé¢‘é“ä¸­ï¼Œç›´æ¥è¿”å›
    if (this.isJoinedChannel && this.currentChannel === channelName) {
      console.log('[ğŸ“¨AgoraRTMManager] å·²åœ¨é¢‘é“ä¸­ï¼Œè·³è¿‡');
      return true;
    }

    // å¦‚æœåœ¨å…¶ä»–é¢‘é“ä¸­ï¼Œå…ˆç¦»å¼€
    if (this.isJoinedChannel && this.currentChannel !== channelName) {
      await this.leaveChannel();
    }

    try {
      console.log('[ğŸ“¨AgoraRTMManager] åŠ å…¥é¢‘é“:', channelName);
      this.currentChannel = channelName;

      // RTM 1.x ä½¿ç”¨ createChannel + join
      this.rtmChannel = this.rtmClient.createChannel(channelName);
      this._setupChannelEventListeners();
      await this.rtmChannel.join();

      this.isJoinedChannel = true;
      console.log('[ğŸ“¨AgoraRTMManager] âœ… åŠ å…¥é¢‘é“æˆåŠŸ');

      return true;
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] åŠ å…¥é¢‘é“å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * ç¦»å¼€é¢‘é“ï¼ˆç¦»å¼€é€šè¯æ—¶è°ƒç”¨ï¼‰
   * @returns {Promise<boolean>}
   */
  async leaveChannel() {
    if (!this.rtmChannel || !this.isJoinedChannel) {
      return true;
    }

    try {
      console.log('[ğŸ“¨AgoraRTMManager] ç¦»å¼€é¢‘é“:', this.currentChannel);

      // RTM 1.x ä½¿ç”¨ channel.leave()
      await this.rtmChannel.leave();

      this.rtmChannel = null;
      this.currentChannel = null;
      this.isJoinedChannel = false;
      // ç§»é™¤æ¶ˆæ¯å›è°ƒ
      this.offMessageReceived();
      console.log('[ğŸ“¨AgoraRTMManager] âœ… ç¦»å¼€é¢‘é“æˆåŠŸ');

      return true;
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] ç¦»å¼€é¢‘é“å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * ç™»å‡º RTMï¼ˆåº”ç”¨é€€å‡ºæ—¶è°ƒç”¨ï¼‰
   * @returns {Promise<boolean>}
   */
  async logout() {
    try {
      // å…ˆç¦»å¼€é¢‘é“
      if (this.isJoinedChannel) {
        await this.leaveChannel();
      }

      // ç™»å‡º RTM
      if (this.rtmClient && this.isLoggedIn) {
        console.log('[ğŸ“¨AgoraRTMManager] ç™»å‡º RTM...');
        await this.rtmClient.logout();
        console.log('[ğŸ“¨AgoraRTMManager] âœ… RTM ç™»å‡ºæˆåŠŸ');
      }
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] ç™»å‡ºå¤±è´¥:', error);
    }

    // é‡ç½®çŠ¶æ€
    this.rtmClient = null;
    this.isLoggedIn = false;
    this.rtmToken = null;

    return true;
  }

  /**
   * è®¾ç½® RTM å®¢æˆ·ç«¯äº‹ä»¶ç›‘å¬ (RTM 1.x æ–¹å¼)
   */
  _setupEventListeners() {
    if (!this.rtmClient) return;

    // è¿æ¥çŠ¶æ€å˜åŒ– (RTM 1.x)
    this.rtmClient.on('ConnectionStateChanged', (newState, reason) => {
      console.log('[ğŸ“¨AgoraRTMManager] è¿æ¥çŠ¶æ€å˜åŒ–:', newState, reason);
    });

    // æ”¶åˆ°ç‚¹å¯¹ç‚¹æ¶ˆæ¯ (RTM 1.x)
    this.rtmClient.on('MessageFromPeer', (message, peerId) => {
      console.log('[ğŸ“¨AgoraRTMManager] æ”¶åˆ°ç‚¹å¯¹ç‚¹æ¶ˆæ¯:', message, 'from:', peerId);
      this._handleReceivedMessage(message, peerId);
    });

    // Token å³å°†è¿‡æœŸ (RTM 1.x)
    this.rtmClient.on('TokenExpired', async () => {
      console.log('[ğŸ“¨AgoraRTMManager] Token å³å°†è¿‡æœŸï¼Œå°è¯•ç»­æœŸ...');
      try {
        const tokenResponse = await getRtmToken();
        if (tokenResponse && tokenResponse.success) {
          const newToken = tokenResponse.data?.rtmToken || tokenResponse.data;
          this.rtmToken = newToken;
          await this.rtmClient.renewToken(newToken);
          console.log('[ğŸ“¨AgoraRTMManager] âœ… Token ç»­æœŸæˆåŠŸ');
        }
      } catch (error) {
        console.error('[ğŸ“¨AgoraRTMManager] Token ç»­æœŸå¤±è´¥:', error);
      }
    });
  }

  /**
   * è®¾ç½®é¢‘é“äº‹ä»¶ç›‘å¬ (RTM 1.x æ–¹å¼)
   */
  _setupChannelEventListeners() {
    if (!this.rtmChannel) return;

    // æ”¶åˆ°é¢‘é“æ¶ˆæ¯ (RTM 1.x)
    this.rtmChannel.on('ChannelMessage', (message, memberId) => {
      console.log('[ğŸ“¨AgoraRTMManager] æ”¶åˆ°é¢‘é“æ¶ˆæ¯:', message, 'from:', memberId);
      this._handleReceivedMessage(message, memberId);
    });

    // é¢‘é“æˆå‘˜åŠ å…¥ (RTM 1.x)
    this.rtmChannel.on('MemberJoined', (memberId) => {
      console.log('[ğŸ“¨AgoraRTMManager] æˆå‘˜åŠ å…¥é¢‘é“:', memberId);
    });

    // é¢‘é“æˆå‘˜ç¦»å¼€ (RTM 1.x)
    this.rtmChannel.on('MemberLeft', (memberId) => {
      console.log('[ğŸ“¨AgoraRTMManager] æˆå‘˜ç¦»å¼€é¢‘é“:', memberId);
    });
  }

  /**
   * å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ (RTM 1.x æ ¼å¼)
   * @param {Object} message - RTM æ¶ˆæ¯å¯¹è±¡
   * @param {string} senderId - å‘é€è€… ID
   */
  _handleReceivedMessage(message, senderId) {
    try {
      // RTM 1.x çš„æ¶ˆæ¯æ ¼å¼æ˜¯ { text: '...' }
      const messageText = message.text;

      // è§£ææ¶ˆæ¯å†…å®¹
      let parsedMessage;
      try {
        parsedMessage = JSON.parse(messageText);
      } catch (e) {
        // å¦‚æœä¸æ˜¯ JSONï¼Œåˆ™ä½œä¸ºçº¯æ–‡æœ¬å¤„ç†
        parsedMessage = {
          type: RTM_MSG_TYPE.TEXT,
          payload: { text: messageText }
        };
      }

      // æ„é€ å…¼å®¹è…¾è®¯ IM æ ¼å¼çš„æ¶ˆæ¯å¯¹è±¡
      const formattedMessage = this._formatMessageForDisplay(parsedMessage, senderId);

      // è§¦å‘æ¶ˆæ¯å›è°ƒ
      if (this.onMessageCallback) {
        this.onMessageCallback({
          data: [formattedMessage]
        });
      }
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
    }
  }

  /**
   * æ ¼å¼åŒ–æ¶ˆæ¯ä¸ºæ˜¾ç¤ºæ ¼å¼ï¼ˆå…¼å®¹è…¾è®¯ IM æ¶ˆæ¯æ ¼å¼ï¼‰
   * @param {Object} parsedMessage - è§£æåçš„æ¶ˆæ¯
   * @param {string} senderId - å‘é€è€… ID
   * @returns {Object} æ ¼å¼åŒ–åçš„æ¶ˆæ¯å¯¹è±¡
   */
  _formatMessageForDisplay(parsedMessage, senderId) {
    const timestamp = Date.now();
    const messageId = `rtm_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;

    // åŸºç¡€æ¶ˆæ¯æ ¼å¼
    const baseMessage = {
      ID: messageId,
      type: parsedMessage.type || RTM_MSG_TYPE.TEXT,
      from: senderId,
      to: this.currentUserId,
      time: Math.floor(timestamp / 1000),
      sequence: timestamp,
      random: Math.floor(Math.random() * 1000000),
      conversationID: `C2C${senderId}`,
      payload: parsedMessage.payload || { text: '' },
      isRTMMessage: true  // æ ‡è®°ä¸º RTM æ¶ˆæ¯
    };

    // å¦‚æœæ˜¯è‡ªå®šä¹‰æ¶ˆæ¯ï¼ˆå¦‚ç¤¼ç‰©ï¼‰ï¼Œæ·»åŠ  customData
    if (parsedMessage.type === RTM_MSG_TYPE.CUSTOM || parsedMessage.customType) {
      baseMessage.type = RTM_MSG_TYPE.CUSTOM;
      baseMessage.customData = parsedMessage.customData || parsedMessage;
    }

    return baseMessage;
  }

  /**
   * å‘é€æ–‡æœ¬æ¶ˆæ¯åˆ°é¢‘é“ (RTM 1.x ä½¿ç”¨ channel.sendMessage)
   * @param {string} text - æ¶ˆæ¯æ–‡æœ¬
   * @returns {Promise<Object>} å‘é€çš„æ¶ˆæ¯å¯¹è±¡
   */
  async sendTextMessage(text) {
    if (!this.rtmChannel || !this.isJoinedChannel) {
      throw new Error('RTM é¢‘é“æœªåŠ å…¥');
    }
      console.log("RTM é¢‘é“",this.rtmChannel)

    try {
      const messageContent = {
        type: RTM_MSG_TYPE.TEXT,
        payload: { text: text }
      };

      // RTM 1.x ä½¿ç”¨ { text: '...' } æ ¼å¼
      const message = { text: JSON.stringify(messageContent) };
      await this.rtmChannel.sendMessage(message);

      console.log('[ğŸ“¨AgoraRTMManager] âœ… æ–‡æœ¬æ¶ˆæ¯å‘é€æˆåŠŸ:', text);

      // è¿”å›æ ¼å¼åŒ–çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆç”¨äºæœ¬åœ°æ˜¾ç¤ºï¼‰
      return this._formatMessageForDisplay(messageContent, this.currentUserId);
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] å‘é€æ–‡æœ¬æ¶ˆæ¯å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * å‘é€ç¤¼ç‰©æ¶ˆæ¯åˆ°é¢‘é“ (RTM 1.x ä½¿ç”¨ channel.sendMessage)
   * @param {Object} gift - ç¤¼ç‰©ä¿¡æ¯
   * @returns {Promise<Object>} å‘é€çš„æ¶ˆæ¯å¯¹è±¡
   */
  async sendGiftMessage(gift) {
    if (!this.rtmChannel || !this.isJoinedChannel) {
      throw new Error('RTM é¢‘é“æœªåŠ å…¥');
    }

    try {
      const messageContent = {
        type: RTM_MSG_TYPE.CUSTOM,
        customType: RTM_MSG_TYPE.GIFT,
        customData: {
          type: RTM_MSG_TYPE.GIFT,
          customType: RTM_MSG_TYPE.GIFT,
          content: gift,
          ...gift
        }
      };

      // RTM 1.x ä½¿ç”¨ { text: '...' } æ ¼å¼
      const message = { text: JSON.stringify(messageContent) };
      await this.rtmChannel.sendMessage(message);

      console.log('[ğŸ“¨AgoraRTMManager] âœ… ç¤¼ç‰©æ¶ˆæ¯å‘é€æˆåŠŸ:', gift);

      // è¿”å›æ ¼å¼åŒ–çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆç”¨äºæœ¬åœ°æ˜¾ç¤ºï¼‰
      return this._formatMessageForDisplay(messageContent, this.currentUserId);
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] å‘é€ç¤¼ç‰©æ¶ˆæ¯å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * å‘é€è‡ªå®šä¹‰æ¶ˆæ¯åˆ°é¢‘é“ (RTM 1.x ä½¿ç”¨ channel.sendMessage)
   * @param {Object} customData - è‡ªå®šä¹‰æ•°æ®
   * @param {number} customType - è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹
   * @returns {Promise<Object>} å‘é€çš„æ¶ˆæ¯å¯¹è±¡
   */
  async sendCustomMessage(customData, customType) {
    if (!this.rtmChannel || !this.isJoinedChannel) {
      throw new Error('RTM é¢‘é“æœªåŠ å…¥');
    }

    try {
      const messageContent = {
        type: RTM_MSG_TYPE.CUSTOM,
        customType: customType,
        customData: customData
      };

      // RTM 1.x ä½¿ç”¨ { text: '...' } æ ¼å¼
      const message = { text: JSON.stringify(messageContent) };
      await this.rtmChannel.sendMessage(message);

      console.log('[ğŸ“¨AgoraRTMManager] âœ… è‡ªå®šä¹‰æ¶ˆæ¯å‘é€æˆåŠŸ:', customData);

      // è¿”å›æ ¼å¼åŒ–çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆç”¨äºæœ¬åœ°æ˜¾ç¤ºï¼‰
      return this._formatMessageForDisplay(messageContent, this.currentUserId);
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] å‘é€è‡ªå®šä¹‰æ¶ˆæ¯å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * è®¾ç½®æ¶ˆæ¯æ¥æ”¶å›è°ƒ
   * @param {Function} callback - å›è°ƒå‡½æ•°
   */
  onMessageReceived(callback) {
    this.onMessageCallback = callback;
  }

  /**
   * ç§»é™¤æ¶ˆæ¯æ¥æ”¶å›è°ƒ
   */
  offMessageReceived() {
    this.onMessageCallback = null;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯
   * @param {string} userId - ç”¨æˆ· ID
   * @returns {boolean}
   */
  isSelf(userId) {
    return String(userId) === String(this.currentUserId);
  }

  /**
   * è·å–å½“å‰ç”¨æˆ· ID
   * @returns {string}
   */
  getCurrentUserId() {
    return this.currentUserId;
  }

  /**
   * é”€æ¯é¢‘é“ï¼ˆç¦»å¼€é€šè¯æ—¶è°ƒç”¨ï¼Œä¸ç™»å‡º RTMï¼‰
   * æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•åªç¦»å¼€é¢‘é“ï¼Œä¸ä¼šç™»å‡º RTMï¼ŒRTM ä¿æŒç™»å½•çŠ¶æ€
   */
  async destroy() {
    console.log('[ğŸ“¨AgoraRTMManager] å¼€å§‹é”€æ¯é¢‘é“...');

    try {
      // ç¦»å¼€é¢‘é“
      await this.leaveChannel();
    } catch (error) {
      console.error('[ğŸ“¨AgoraRTMManager] é”€æ¯é¢‘é“å‡ºé”™:', error);
    }

    console.log('[ğŸ“¨AgoraRTMManager] âœ… é¢‘é“é”€æ¯å®Œæˆ');
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
   * @returns {boolean}
   */
  checkLoggedIn() {
    return this.isLoggedIn;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²åŠ å…¥é¢‘é“
   * @returns {boolean}
   */
  checkJoinedChannel() {
    return this.isJoinedChannel;
  }
}

// å¯¼å‡ºå•ä¾‹
export default AgoraRTMManager.getInstance();
